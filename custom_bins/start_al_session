#!/bin/bash
# Start a tmux session with audit command logging on all panes
# Usage: start_al_session /path/to/project [session_name]
set -euo pipefail

PROJECT_DIR="${1:?Usage: start_al_session /path/to/project [session_name]}"
PROJECT_DIR="$(realpath "$PROJECT_DIR")"
SESSION_NAME="${2:-audit}"

SCRIPT_DIR="$(dirname "$(readlink -f "$0")")"
AL_SCRIPT="${SCRIPT_DIR}/../../exploration_hacking/src/static_bash_scripts/audit_logger.sh"
if [[ ! -f "$AL_SCRIPT" ]]; then
    echo "ERROR: audit_logger.sh not found at ${AL_SCRIPT}"
    exit 1
fi

if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
    echo "[*] Session '${SESSION_NAME}' exists, setting AL_PROJECT_DIR and attaching"
    tmux set-environment -t "$SESSION_NAME" AL_PROJECT_DIR "$PROJECT_DIR"
    tmux attach -t "$SESSION_NAME"
else
    tmux new-session -d -s "$SESSION_NAME"
    tmux set-environment -t "$SESSION_NAME" AL_PROJECT_DIR "$PROJECT_DIR"
    # First pane: file watcher (foreground)
    tmux send-keys -t "$SESSION_NAME" "$AL_SCRIPT $PROJECT_DIR" Enter
    # Second pane: working shell (auto-starts command logging via AL_PROJECT_DIR)
    tmux split-window -v -t "$SESSION_NAME"
    tmux attach -t "$SESSION_NAME"
fi
