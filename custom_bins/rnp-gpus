#!/bin/bash
set -euo pipefail
source /workspace/exploration_hacking/.env
DC="${1:-US-GA-2}"
curl -s "https://api.runpod.io/graphql?api_key=$RUNPOD_API_KEY" \
    -H 'Content-Type: application/json' \
    -d '{"query":"{ gpuTypes { id memoryInGb } dataCenters { id gpuAvailability { stockStatus gpuTypeId gpuTypeDisplayName } } }"}' \
    | jq -r --arg dc "$DC" '
        {
            "NVIDIA H200": "h200", "NVIDIA H200 NVL": "h200-nvl",
            "NVIDIA H100 80GB HBM3": "h100-sxm", "NVIDIA H100 NVL": "h100-nvl", "NVIDIA H100 PCIe": "h100-pcie",
            "NVIDIA B200": "b200", "NVIDIA A100-SXM4-80GB": "a100-sxm", "NVIDIA A100 80GB PCIe": "a100-pcie",
            "NVIDIA A40": "a40", "NVIDIA L40S": "l40s", "NVIDIA L4": "l4", "NVIDIA GeForce RTX 4090": "4090"
        } as $aliases |
        ([.data.gpuTypes[] | {(.id): .memoryInGb}] | add) as $mem |
        .data.dataCenters[] | select(.id==$dc) | .gpuAvailability[] |
        "\(.stockStatus)\t\($aliases[.gpuTypeId] // "-")\t\($mem[.gpuTypeId] // "?")GB\t\(.gpuTypeDisplayName)"
    ' | sort | awk -F'\t' '{printf "%-8s %-12s %6s  %s\n", $1, $2, $3, $4}'
